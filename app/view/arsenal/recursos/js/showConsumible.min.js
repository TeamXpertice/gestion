function guardarConsumiblesSeleccionados(){Object.keys(consumiblesSeleccionados).length>0&&(actualizarVistaPrevia(),$("#modalConsumibles").removeClass("show").css("display","none"))}function borrarConsumiblesSeleccionados(){consumiblesSeleccionados={},actualizarVistaPrevia(),document.querySelectorAll('#listaConsumibles input[type="checkbox"]').forEach(e=>{e.checked=!1})}function calcularGanancia(){var e=parseFloat(document.getElementById("precio_unitario").value),t=parseInt(document.getElementById("stock").value),o=parseFloat(document.getElementById("coste").value);if(!(isNaN(e)||isNaN(t)||isNaN(o)||e<=0||t<=0||o<=0)){var n=e*t-o,a=(n/o*100).toFixed(2);document.getElementById("gananciaProducto").innerHTML=`Ganancia: S/. ${n.toFixed(2)} (${a}%)`}}function agregarDias(e,t){var o=document.getElementById(e),n=new Date(o.value);isNaN(n.getTime())&&(n=new Date),n.setDate(n.getDate()+t);var a=n.toISOString().split("T")[0];o.value=a}function cargarConsumiblesPorCategoria(e){e?fetch(`/gestion/app/controller/ArsenalController.php?action=obtenerConsumiblesPorCategoria&categoria_id=${e}`).then(e=>e.json()).then(e=>{const t=document.getElementById("listaConsumibles");if(t.innerHTML="",e.length>0){const o={};e.forEach(e=>{o[e.id]||(o[e.id]={id:e.id,nombre:e.nombre,precio:e.precio,lotes:[]}),o[e.id].lotes.push({stock:e.stock})}),Object.values(o).forEach(e=>{const o=document.createElement("div");o.classList.add("mb-2");const n=document.createElement("input");n.type="checkbox",n.id=`consumible_${e.id}`,n.value=e.id,n.classList.add("mr-2");const a=document.createElement("input");a.type="number",a.min=1,a.value=1,a.classList.add("ml-2"),n.addEventListener("change",function(){this.checked?consumiblesSeleccionados[e.id]={id:e.id,nombre:e.nombre,cantidad:a.value,precio:e.precio,lotes:e.lotes}:delete consumiblesSeleccionados[e.id],actualizarVistaPrevia()}),a.addEventListener("input",function(){n.checked&&(consumiblesSeleccionados[e.id].cantidad=this.value,actualizarVistaPrevia())}),o.appendChild(n),o.appendChild(document.createTextNode(`${e.nombre} - Precio: S/. ${e.precio}`)),o.appendChild(a),t.appendChild(o)})}else t.innerHTML="<p>No hay consumibles en esta categoría.</p>"}).catch(e=>{console.error("Error al cargar los consumibles:",e),document.getElementById("listaConsumibles").innerHTML="<p>Error al cargar los consumibles.</p>"}):document.getElementById("listaConsumibles").innerHTML="<p>Seleccione una categoría para ver los consumibles.</p>"}function actualizarVistaPrevia(){const e=document.getElementById("vistaPreviaSeleccion");e.innerHTML="",Object.keys(consumiblesSeleccionados).length>0?Object.values(consumiblesSeleccionados).forEach(t=>{const o=document.createElement("div");o.textContent=`${t.nombre} - Cantidad: ${t.cantidad} - Precio Unitario: S/. ${t.precio}`;const n=t.lotes.map((e,t)=>`${t+1}° Lote - Stock: ${e.stock}`).join(" | "),a=document.createElement("small");a.textContent=`Detalles de lotes: ${n}`,o.appendChild(document.createElement("br")),o.appendChild(a),e.appendChild(o)}):e.innerHTML="<p>No hay consumibles seleccionados.</p>"}let consumiblesSeleccionados={};const toggleButton=document.getElementById("toggleCompuestos"),cardCompuestos=document.getElementById("cardCompuestos"),cardSimples=document.getElementById("cardSimples"),cardSimplesCol=cardSimples.classList,cardCompuestosCol=cardCompuestos.classList;window.addEventListener("DOMContentLoaded",function(){cardCompuestos.style.display="none",cardSimplesCol.add("col-md-12"),cardSimplesCol.remove("col-md-6")}),toggleButton.addEventListener("click",function(){const e="none"!==cardCompuestos.style.display;cardCompuestos.style.display=e?"none":"block",toggleButton.textContent=e?"Mostrar Compuestos":"Ocultar Compuestos",e?(cardSimplesCol.remove("col-md-8"),cardSimplesCol.add("col-md-12")):(cardSimplesCol.remove("col-md-12"),cardSimplesCol.add("col-md-8"))}),document.getElementById("precio_unitario").addEventListener("input",calcularGanancia),document.getElementById("stock").addEventListener("input",calcularGanancia),document.getElementById("coste").addEventListener("input",calcularGanancia),$(document).ready(function(){function e(e){$.fn.DataTable.isDataTable(e)&&($(e).DataTable().destroy(),$(e).empty()),$(e).DataTable({language:{url:"/gestion/public/js/SpanishDataTable1.10.21/Spanish.json"},dom:"Bfrtip",buttons:[{extend:"excel",text:'<i class="fas fa-file-excel"></i> Excel',title:"Consumibles_Registrados",className:"btn-excel"},{extend:"print",text:'<i class="fas fa-print"></i> Imprimir',title:"Consumibles Registrados",exportOptions:{columns:":not(:last-child)"},className:"btn-print"}]})}e("#tablaConsumiblesSimples"),e("#tablaCompuestos"),document.querySelector("form").addEventListener("submit",function(e){e.preventDefault();const t=new FormData(this);fetch("/gestion/app/controller/ArsenalController.php?action=CrearConsumibleSimple",{method:"POST",body:t}).then(e=>e.json()).then(e=>{e.success?Swal.fire({icon:"success",title:"¡Consumible creado!",text:"El consumible se ha creado exitosamente.",timer:2e3,showConfirmButton:!1}).then(()=>{window.location.href="/gestion/app/controller/ArsenalController.php?action=showConsumible"}):Swal.fire({icon:"error",title:"Error",text:"Hubo un problema al crear el consumible."})}).catch(e=>{Swal.fire({icon:"error",title:"Error",text:"Hubo un problema con la solicitud."})})}),document.getElementById("formConsumibleCompuesto").addEventListener("submit",function(e){e.preventDefault();const t=new FormData(this);t.append("componentes",JSON.stringify(consumiblesSeleccionados)),fetch(this.action,{method:"POST",body:t}).then(e=>e.json()).then(e=>{e.success?Swal.fire({icon:"success",title:"Consumible compuesto guardado",text:"El consumible compuesto se ha guardado exitosamente.",timer:1e3,showConfirmButton:!1}).then(()=>{setTimeout(()=>{location.reload()},50)}):Swal.fire({icon:"error",title:"Error",text:e.error||"Ocurrió un error al guardar el consumible."})}).catch(e=>console.error("Error al enviar el formulario:",e))}),$("#addCategoriaBtn").on("click",function(){const e=$("#nuevaCategoria").val();e?fetch("/gestion/app/controller/ArsenalController.php?action=addCategoria",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`nombre=${encodeURIComponent(e)}`}).then(e=>e.json()).then(e=>{e.success?Swal.fire({icon:"success",title:"¡Categoría agregada!",text:"La categoría se ha agregado exitosamente.",timer:2e3,showConfirmButton:!1}).then(()=>{location.reload()}):Swal.fire({icon:"error",title:"Error",text:"Hubo un problema al agregar la categoría."})}).catch(e=>{Swal.fire({icon:"error",title:"Error",text:"Hubo un problema con la solicitud."})}):Swal.fire({icon:"warning",title:"Campo vacío",text:"Por favor, ingresa el nombre de la categoría."})}),document.addEventListener("DOMContentLoaded",function(){function e(){o.forEach(e=>{e.style.display=t.checked?"table-row":"none"})}const t=document.getElementById("toggleCompuestos"),o=document.querySelectorAll(".compuesto");e(),t.addEventListener("change",e)})});