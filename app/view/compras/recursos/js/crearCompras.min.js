function agregarProducto(o,e,t,a){if(o){var r=productosSeleccionados.find(e=>e.id===o);r?r.sinStock?Swal.fire({icon:"warning",title:"Producto sin stock",text:"Este producto no tiene stock disponible."}):r.cantidad+=a:productosSeleccionados.push({id:o,nombre:e,cantidad:a>0?a:0,costo_total:0,precio_unitario:t,fecha_ingreso:"",fecha_vencimiento:"",sinStock:0===a}),ultimoProducto=productosSeleccionados[productosSeleccionados.length-1],actualizarVistaPrevia()}else console.error("ID de producto no especificado")}function actualizarVistaPrevia(){var o=0,e="";productosSeleccionados.length>0?(e='<ul class="list-group">',productosSeleccionados.forEach(function(t,a){o+=parseFloat(t.costo_total||0),e+=`<li class="list-group-item">\n                        <div><strong>${t.nombre}</strong> ${t.sinStock?'<span class="text-danger">(Sin stock)</span>':""}</div>\n                        <div class="form-group">\n                            <label>Cantidad:</label>\n                            <input type="number" min="1" class="form-control" value="${t.cantidad}" \n                                   onchange="actualizarCantidad(${a}, this.value)" ${t.sinStock,""}>\n                        </div>\n                        <div class="form-group">\n                            <label>Costo Total:</label>\n                            <input type="number" step="0.01" class="form-control" value="${t.costo_total}" \n                                   onchange="actualizarCostoTotal(${a}, this.value)">\n                        </div>\n                        <div class="form-group">\n                            <label>Precio Unitario:</label>\n                            <input type="number" step="0.01" class="form-control" value="${t.precio_unitario}" \n                                   onchange="actualizarPrecioUnitario(${a}, this.value)">\n                        </div>\n                        <div class="form-group">\n                            <label>Fecha de Ingreso:</label>\n                            <input type="date" class="form-control" value="${t.fecha_ingreso||""}" \n                                   onchange="actualizarFechaIngreso(${a}, this.value)">\n                        </div>\n                        <div class="form-group">\n                            <label>Fecha de Vencimiento:</label>\n                            <input type="date" class="form-control" value="${t.fecha_vencimiento||""}" \n                                   onchange="actualizarFechaVencimiento(${a}, this.value)">\n                        </div>\n                     </li>`}),e+="</ul>"):e="<p>No hay productos seleccionados.</p>",$("#compraPreview").html(e),$("#totalCompra").html("<h4>Total: S/."+o.toFixed(2)+"</h4>"),$("#productosSeleccionados").val(JSON.stringify(productosSeleccionados))}function actualizarCantidad(o,e){productosSeleccionados[o].cantidad=parseInt(e),actualizarVistaPrevia()}function actualizarCostoTotal(o,e){productosSeleccionados[o].costo_total=parseFloat(e),actualizarVistaPrevia()}function actualizarPrecioUnitario(o,e){productosSeleccionados[o].precio_unitario=parseFloat(e)}function actualizarFechaIngreso(o,e){productosSeleccionados[o].fecha_ingreso=e}function actualizarFechaVencimiento(o,e){productosSeleccionados[o].fecha_vencimiento=e}function mostrarConsumiblesPorCategoria(o){$.ajax({url:"/gestion/app/controller/ComprasController.php",type:"GET",dataType:"json",data:{action:"obtenerConsumiblesPorCategoria",categoria_id:o},success:function(o){try{var e=o,t={};e.forEach(function(o){var e=o.nombre.toUpperCase();t[e]||(t[e]={id:o.id,nombre:o.nombre,detalles:[]}),o.stock>0&&t[e].detalles.push({stock:o.stock,precio:parseFloat(o.precio).toFixed(2),fecha_vencimiento:o.fecha_vencimiento})});var a='<table class="table table-bordered"><thead><tr><th>Nombre</th><th>Detalles</th><th>Acción</th></tr></thead><tbody>';for(var r in t){var n=t[r];if(0===n.detalles.length)a+=`<tr>\n                                    <td>${n.nombre}</td>\n                                    <td>Sin stock</td>\n                                    <td><button type="button" class="btn btn-warning" onclick="agregarProducto(${n.id}, '${n.nombre}', 0, 0)">Agregar</button></td>\n                                 </tr>`;else{n.detalles.sort((o,e)=>new Date(o.fecha_vencimiento)-new Date(e.fecha_vencimiento));var i=n.detalles.map((o,e)=>`${e+1}° Cantidad: ${o.stock} | ${e+1}° Precio de Venta: S/. ${o.precio} | Vence: ${o.fecha_vencimiento}`).join("<br>");a+=`<tr>\n                                    <td>${n.nombre}</td>\n                                    <td>${i}</td>\n                                    <td><button type="button" class="btn btn-success" onclick="agregarProducto(${n.id}, '${n.nombre}', ${n.detalles[0].precio}, ${n.detalles[0].stock})">Agregar</button></td>\n                                 </tr>`}}a+="</tbody></table>",$("#consumiblesList").html(a)}catch(o){console.error("Error al analizar la respuesta JSON:",o),$("#consumiblesList").html("<p>Error al cargar los consumibles.</p>")}},error:function(o,e,t){console.error("Error AJAX:",e,t),$("#consumiblesList").html("<p>Error al cargar los consumibles.</p>")}})}var productosSeleccionados=[],ultimoProducto=null;$("#compraConsumiblesForm").on("submit",function(o){if(o.preventDefault(),0!==productosSeleccionados.length){var e=$("#metodoCompra").val();$.ajax({url:"/gestion/app/controller/ComprasController.php?action=registrarCompraConsumible",type:"POST",data:{productosSeleccionados:JSON.stringify(productosSeleccionados),metodo_pago:e},dataType:"json",success:function(o){o.success?Swal.fire({icon:"success",title:"Compra registrada",text:o.message,showConfirmButton:!1,timer:2e3}).then(()=>{window.location.reload()}):Swal.fire({icon:"error",title:"Error",text:o.message})},error:function(o,e,t){console.error("Error AJAX:",o.responseText),Swal.fire({icon:"error",title:"Error",text:"Ocurrió un error en la solicitud. Inténtalo de nuevo."})}})}else Swal.fire({icon:"warning",title:"¡Atención!",text:"Debes seleccionar al menos un producto para registrar la compra."})}),$("#compraComunForm").submit(function(o){o.preventDefault();var e=$(this).serialize();$.ajax({url:"/gestion/app/controller/ComprasController.php?action=registrarCompraComun",type:"POST",data:e,dataType:"json",success:function(o){o.success?Swal.fire({icon:"success",title:"Éxito",text:o.message,showConfirmButton:!1,timer:2e3}).then(()=>{window.location.href="/gestion/app/controller/ComprasController.php?action=showCompras"}):Swal.fire({icon:"error",title:"Error",text:o.message})},error:function(o,e,t){console.error("Error AJAX:",o.responseText),Swal.fire({icon:"error",title:"Error",text:"Ocurrió un error en la solicitud. Inténtalo de nuevo."})}})});